name: TP5 - Pipeline Completo (CI/CD/Security)

on:
    push:
        branches: ["master", "main"]
        paths:
            - "TP5/**"
    pull_request:
        branches: ["master", "main"]
        paths:
            - "TP5/**"
    workflow_dispatch:

jobs:
    security-build-test:
        name: ğŸ›¡ï¸ SeguranÃ§a e Qualidade
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: ./TP5/com-cliente-projeto
        permissions:
            actions: read
            contents: read
            security-events: write

        steps:
            - name: Checkout do CÃ³digo
              uses: actions/checkout@v4

            - name: Configurar Java 17
              uses: actions/setup-java@v4
              with:
                  java-version: "17"
                  distribution: "temurin"
                  cache: "maven"

            - name: ğŸ›¡ï¸ Inicializar CodeQL
              uses: github/codeql-action/init@v3
              with:
                  languages: java

            - name: ğŸ—ï¸ Build e Testes UnitÃ¡rios
              run: mvn clean verify

            - name: ğŸ•µï¸â€â™‚ï¸ Realizar AnÃ¡lise CodeQL
              uses: github/codeql-action/analyze@v3
              with:
                  category: "/language:java"

            - name: ğŸ“¤ Upload RelatÃ³rio JaCoCo
              uses: actions/upload-artifact@v4
              with:
                  name: tp5-relatorio-cobertura
                  path: TP5/com-cliente-projeto/target/site/jacoco/

            - name: ğŸ“¦ Upload do JAR da AplicaÃ§Ã£o
              uses: actions/upload-artifact@v4
              with:
                  name: tp5-app-jar
                  path: TP5/com-cliente-projeto/target/*.jar

    testes-e2e-pos-deploy:
        name: ğŸŒ Testes E2E (Selenium Headless)
        needs: security-build-test
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: ./TP5/com-cliente-projeto

        steps:
            - name: Checkout do CÃ³digo
              uses: actions/checkout@v4

            - name: Configurar Java 17
              uses: actions/setup-java@v4
              with:
                  java-version: "17"
                  distribution: "temurin"
                  cache: "maven"

            - name: ğŸŒ Executar Testes E2E
              run: mvn test -Dtest=*E2ETest
